---
title: "Reading Data from APIs"
output: github_document
    theme: flatly
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(httr)
library(jsonlite)
library(ggplot2)
library(tidyjson)

```

## Requirements

The packages used in this vignette are 

[tidyverse](https://www.tidyverse.org/)
[httr](https://httr2.r-lib.org/)
[jsonlite](https://cran.r-project.org/package=jsonlite)

## API

I wanted to query the National Parks service API which provides information about US National Parks. In order to interact with this API you will need an api key. You can register for a free API key [here](https://www.nps.gov/subjects/developer/get-started.htm). This API allows 1,000 requests per hour! That's pretty generous as far as APIs go. You can also read more information about it in the [API Guide](https://www.nps.gov/subjects/developer/guides.htm). In order to keep my own API key a secret I have aliased it in the remaining code as `my_api_key`, but you can create a variable called `my_api_key` which will be the default of the functions in this vignette, or you can simply enter your api key into the functions.  


```{r, echo = FALSE}

#nothing to see here
my_api_key <- 'iGcTVkjLRg4ruBc2hld67MDP0XtzaeEygeY0eUlf'

```


## Functions

There are several functions I created in order to interact with the API. The first is `get_parks` which allows the user to get the park code, park name, state abbreviation(s), and a description of each of the national parks. The user has a few options. They may enter a text value for the state abbreviation the whole state name, or "all" for all states. The state name and code are case insensitive. They may also enter a park code. 

The National Parks API allows the user to set a limit of how many results to return. This is helpful if you don't want to return too many results, but can be problematic if you don't know how many results there actually are. Thankfully when the data is returned the total number of possible results is also returned in a field called "total". We will use this field to make sure we don't inadvertently return too few results. 

```{r}

get_max_api_results <- function(url) {
    
    #call the api
    api_call <- GET(url)
    
    #parse the data from JSON
    parsed_data <- fromJSON(rawToChar(api_call$content))
    
    #if the number of results possible is greater than the number of results returned, call the api again with the max possible results
    if(as.numeric(parsed_data$limit) < as.numeric(parsed_data$total)) {
        
        url <- paste0(url, '&limit=', parsed_data$total)
        
        api_call <- GET(url)
        
        parsed_data <- fromJSON(rawToChar(api_call$content))
    
    }
    
    #return the parsed_data
    return(parsed_data)
    
}

```



```{r}

get_parks <- function(state = 'all', park_code = NULL, api_key = my_api_key) { 
    
    #start with a base url of the api call
    url <-  'https://developer.nps.gov/api/v1/parks?'
    
    #convert the state parameter to lower case
    state <- tolower(state)
    #convert built in state abbreviations and state names to lower case
    state_abbs <- tolower(state.abb)
    state_names <- tolower(state.name)
    
    #if the state entered by the user is a state name:
    if(state %in% state_names) {
        
         #get the index of the state.name and return the abbreviation at that index
        state <- state_abbs[which(state_names == state)]
        
    }
    
    
    #if the user entered a state abbreviation (or a state name that has been converted to an abbreviation)
    if(state %in% state_abbs) {
        
        #add the state parameter to the url
        url <- paste0(url,'&state=', state)
        
    #if the state is not an abbreviation or 'all'
    }else if(!state %in% c('all', state_abbs)) {
        
        #output a helpful error message
        stop("Please enter a valid state name or abbreviation or 'all' to query all states")
        
    }
    
    
    #if the park code is not null
    if(!is.null(park_code)) {
        
        #add the park_code to the url
       url <- paste0(url,'&park=', state) 
    }
    
    #add the api key to the url
    url <- paste0(url,'&api_key=', my_api_key)
   
    out <- get_max_api_results(url)
    
    return(out)
    
}

```

Now let's test out our function:

```{r}

test <- get_parks(state = 'nc')

as.numeric(test$limit) < as.numeric(test$total)

```




```{r scratchpad, echo = FALSE, eval = FALSE}
state.name
state.abb

campgrounds <- GET("https://developer.nps.gov/api/v1/campgrounds/amenities?limit=1000&api_key=iGcTVkjLRg4ruBc2hld67MDP0XtzaeEygeY0eUlf")

alerts <- GET("https://developer.nps.gov/api/v1/alerts?api_key=iGcTVkjLRg4ruBc2hld67MDP0XtzaeEygeY0eUlf")

test <- fromJSON(rawToChar(alerts$content))

parsed_campgrounds <- fromJSON(rawToChar(campgrounds$content))$data %>%
    unnest(amenities, names_sep = '_') %>%
    unnest(fees, names_sep = '_') %>%
    unnest(passportStampImages, names_sep = '_')

amenities <- parsed_campgrounds$amenities
    
?unnest    

activities <- GET("https://developer.nps.gov/api/v1/activities/parks?limit=100&api_key=iGcTVkjLRg4ruBc2hld67MDP0XtzaeEygeY0eUlf")

activities$content

parsed_activities <- fromJSON(rawToChar(activities$content))

combined_activities <- parsed_activities$data %>%
    rename('activity' = name) %>%
    unnest(parks)

activities_with_campgrounds <- parsed_campgrounds %>%
    inner_join(combined_activities, by = park_code)



```


## Exploratory Analysis

```{r}
#EDA Requirements (A few requirements about your EDA are below:
#∗ You should pull data from at least two separate calls to your API functions
#∗ You should create some contingency tables
#∗ You should create numerical summaries for some quantitative variables at each setting of some
#of your categorical variables
#∗ You should create at least five plots utilizing coloring, grouping, etc. All plots should have
#nice labels and titles.
#· At least one plot that you create should be a plot that we didn’t cover in class (say a
#heatmap or something like that - lots of good examples to consider here https://exts.
#ggplot2.tidyverse.org/gallery/))


```

